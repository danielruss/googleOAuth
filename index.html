<!DOCTYPE html>
<html>

<head>
  <script src="https://accounts.google.com/gsi/client" onload="initClient()" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"
    integrity="sha512-+BMamP0e7wn39JGL8nKAZ3yAQT2dL5oaXWr4ZYlTGkKOaoXM/Yj7c4oy50Ngz5yoUutAG17flueD4F6QpTlPng=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <h1>Google Identity Services Authorization Token model</h1>
  <script type="module">
    import emb from "./embedding.js"
    window.emb = emb
    emb.tokenBar()
  </script>

  <textarea rows="10"></textarea>

  <button data-require-token="true" onclick="embed();">embed text</button><br><br>
  <table id="resTable"></table>

  <script>
    // https://developers.google.com/identity/oauth2/web/guides/migration-to-gis?authuser=1#gis-only
    var client;

    function initClient() {

      client = google.accounts.oauth2.initTokenClient({
        client_id: '470984582294-ciqa45m21eqsli2v0m8kqdsobl2690jg.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/cloud-platform',
        callback: (tokenResponse) => {
          tokenResponse.expireAt = Date.now() + (tokenResponse.expires_in - 120) * 1000
          localStorage.setItem('token', JSON.stringify(tokenResponse))
          emb.buttonSet()
        },
      });

    }

    async function embed() {
      if (!emb.hasToken()) {
        emb.getToken()
        return
      }
      token = emb.getToken()
      let text = document.querySelector("textarea").value
      if (text.length < 1) return

      let instances = text.split("\n").map(x => ({ content: x }))

      let unique_text = []
      let embed_index = {}

      // I hate for loops, but forEach does not await...
      // https://stackoverflow.com/a/37576787/
      for ([index, instance] of instances.entries()) {
        if (instance.content.trim().length==0) continue
        console.log(instance.content)
        let cache = await localforage.getItem(instance.content)
        if (cache) {
          instance.status = "cached"
          instance.embeddings = cache;
          unique_text.push(instance.content)
          continue
        }
        embed_index[instance.content] = embed_index[instance.content] ?? []
        embed_index[instance.content].push(index)
        if (!unique_text.includes(instance.content)) {
          instance.status = "embed"
          unique_text.push(instance.content)
          continue
        }
        instance.status = "duplicate"
      }

      window.instances = instances;
      embed_instances = instances.filter((instance) => instance.status == "embed")
      window.embed_instances = embed_instances

      if (embed_instances.length > 0) {
        let project = "nih-nci-dceg-druss";
        let base_url = `https://us-central1-aiplatform.googleapis.com/v1/projects/${project}/locations/us-central1/publishers/google/models/textembedding-gecko:predict`
        let options = {
          headers: {
            'Authorization': `Bearer ${token.access_token}`
          },
          method: "POST",
          body: JSON.stringify({
            "instances": embed_instances
          })
        }
        let results = await (await fetch(base_url, options)).json()
        if (results.error) {
          console.error(`${results.error.message}`)
          return
        }
        window.results = results
        results.predictions.forEach((embedding,index) => {
          // we only embed the embed_instance
          let text_embedded = embed_instances[index].content
          localforage.setItem(text_embedded, embedding.embeddings)

          // get the original indices for this text
          embed_index[text_embedded]?.forEach(indx => instances[indx].embeddings=embedding.embeddings)
        });
      }

      return instances
    }
  </script>

</body>

</html>