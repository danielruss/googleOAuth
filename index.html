<!DOCTYPE html>
<html>
  <head>
    <script src="https://accounts.google.com/gsi/client" onload="initClient()" async defer></script>
  </head>
  <body>
    <script>
      // https://developers.google.com/identity/oauth2/web/guides/migration-to-gis?authuser=1#gis-only
      var client;
      var access_token;

      function initClient() {

        client = google.accounts.oauth2.initTokenClient({
          client_id: '470984582294-ciqa45m21eqsli2v0m8kqdsobl2690jg.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/bigquery',
          callback: (tokenResponse) => {
            access_token = tokenResponse.access_token;
            tokenResponse.expireAt = Date.now() + (tokenResponse.expires_in - 120)*1000
            console.log(tokenResponse)
            localStorage.setItem('token',JSON.stringify(tokenResponse))
          },
        });

      }

      function getToken() {
        let token = JSON.parse(localStorage.getItem('token'))
        if (token && token?.expireAt >= Date.now()) {
          access_token = token.access_token
          return token;
        }
        client.requestAccessToken();
      }
      function revokeToken() {
        google.accounts.oauth2.revoke(access_token, () => {console.log('access token revoked')});
        delete localStorage.token
      }

      function makeTable(x){
        let table = document.getElementById("resTable")
        table.innerText=""
        let headElement = table.createTHead()
        let rowElement = headElement.insertRow()
        x.columns.forEach(col =>{
          let cell=rowElement.insertCell()
          cell.outerHTML = `<th>${col}</th>`
        })

        let bodyElement = table.createTBody()
        x.rows.forEach(row => {
          rowElement = bodyElement.insertRow()
          row.f.forEach(value =>{
            let cell=rowElement.insertCell()
            cell.innerText = value.v
          })
        });
      }


      async function loadCalendar() {
        getToken()

        let project="nih-nci-dceg-druss";
        let dataset="DansDataset"
        let table="FakeData"
        //https://bigquery.googleapis.com/bigquery/v2/projects/nih-nci-dceg-druss/datasets/DansDataset/tables/FakeData/data?maxResults=20&selectedFields=Id%2CToken&key=[YOUR_API_KEY]'
        let base_url=`https://bigquery.googleapis.com/bigquery/v2/projects/${project}/datasets/${dataset}/tables/${table}/data`
        let token = "lala"
        let options = {
          headers: {
            'Authorization': `Bearer ${access_token}`
          }
        }
        console.log(base_url)
        console.log(options)
        let x = await (await fetch(base_url,options)).json()
        x.columns=["Id","Token"]
        console.log(x)

        makeTable(x)
      }
    </script>
    <h1>Google Identity Services Authorization Token model</h1>
    <button onclick="getToken();">Get access token</button><br><br>
    <button onclick="loadCalendar();">Load Calendar</button><br><br>
    <button onclick="revokeToken();">Revoke token</button>
    <table id="resTable"></table>
  </body>
</html>
